## 一、开端

### 1.1. 总览

```C++
//选自 https://www.cnblogs.com/shuqin/p/12214439.html
spdlog
    ├─example  用法代码
    ├─include  实现目录
    │  └─spdlog
    │      ├─details  功能函数目录
    │      ├─fmt  {fmt} 库目录
    │      ├─sinks  落地文件格式实现
    │      └─*.h    异步模式，日志库接口等实现
    ├─src  .cpp 文件，组成编译模块生成静态库使用
    ├─test  测试代码
```

别人画的类图([spdlog源码分析-整体框架_spdlog架构_注定会的博客-CSDN博客](https://blog.csdn.net/csenjoy/article/details/96337751?spm=1001.2014.3001.5502))：

<img src="https://img-blog.csdnimg.cn/20190717194316356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NzZW5qb3k=,size_16,color_FFFFFF,t_70" alt="img" style="zoom:150%;" />

### 1.2. level

日志的级别在`include\spdlog\common.h`中，由枚举`level_enum`给出。由低到高为`trace debug info warn err critical off`。**默认级别为info(define SPDLOG_ACTIVE_LEVEL SPDLOG_LEVEL_INFO)**

相关主要函数有`to_string_view`和`from_str`，功能分别为根据枚举获取字符串和根据字符串获取枚举值。

这些内容都在`namespace level`中



## 二、example

这节简单看一下example。

**几点发现：**

1. 支持格式化、多线程、异步、多输出目标、计时、自定义类型格式化、自定义异常信息处理等功能
2. **spdlog::[info/warn/...]**使用的是默认的logger作为输出
3. **spdlog::xxx_xxx_[mt/st]**为自己新建logger时用的api。

下阶段目标是看懂默认的输出(以info为例)。

输出一条日志的过程大致为：`spdlog::info -> details::registry中的默认logger.info -> 构造details::log_msg -> logger::log_it_ -> 该logger的所有sink.log`

看起来要先弄清 details::log_msg和sink。



## 三、details::log_msg

### 3.1. source_loc结构体

位于`include\spdlog\common.h`。记录了打日志的地方所在的文件名、行数、函数名

```c++
struct source_loc
{
    SPDLOG_CONSTEXPR source_loc() = default; 
    SPDLOG_CONSTEXPR source_loc(const char *filename_in, int line_in, const char *funcname_in)
        : filename{filename_in}
        , line{line_in}
        , funcname{funcname_in}
    {}

    SPDLOG_CONSTEXPR bool empty() const SPDLOG_NOEXCEPT
    {
        return line == 0;
    }
    const char *filename{nullptr};
    int line{0};
    const char *funcname{nullptr};
};
```

SPDLOG_CONSTEXPR宏在我的环境下被扩展成了`constexpr`。

**constexpr构造函数**，把这个类变为一个**"字面值常量类"**（https://blog.csdn.net/craftsman1970/article/details/80244873）。constexpr构造函数的函数体一般为空，使用初始化列表或者其他的constexpr构造函数初始化所有数据成员。

**constexpr修饰其它函数**，将运算尽量放在编译阶段。函数只能有一个return语句

 **= default** 启用默认的构造函数

SPDLOG_NOEXCEPT宏在我的环境下被扩展成了`noexcept`。该关键字告诉编译器，函数中不会发生异常，这有利于编译器对程序做更多的优化。如果在运行时，noexecpt函数向外抛出了异常（如果函数内部捕捉了异常并完成处理，这种情况不算抛出异常），程序会直接终止，调用std::terminate()函数，该函数内部会调用std::abort()终止程序

### 3.2. log_msg

构造函数中提供了多种构造。成员如下，包括logger名、级别、线程id、位置等

```c++
    string_view_t logger_name;
    level::level_enum level{level::off};
    log_clock::time_point time; //using log_clock = std::chrono::system_clock; time_point表示一个时间点
    size_t thread_id{0};

    // wrapping the formatted text with color (updated by pattern_formatter).
    mutable size_t color_range_start{0};
    mutable size_t color_range_end{0};

    source_loc source;
    string_view_t payload; //存储的是msg
```

构造时如果不指定时间，默认为当前时间。





